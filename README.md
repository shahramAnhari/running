# Shotarun Coach/Student App

این پروژه یک رابط وب برای مدیریت تعامل بین مربی و شاگرد (و در ادامه ادمین) است. سه صفحهٔ اصلی زیر `/app/` وجود دارد:

- `app/coach.html` – داشبورد مربی برای ساخت برنامه، گروه‌بندی شاگردان، تأیید درخواست‌های عضویت و مشاهده داده‌های شاگرد.
- `app/student.html` – پنل شاگرد (بازطراحی‌شده همراه با تم تیره) برای ورود/ثبت‌نام با ایمیل، مشاهده برنامه‌ها، پرداخت‌ها، اهداف، دفترچه تمرین و پروفایل.
- `app/admin.html` – ابزار مدیریت مربی‌ها و ادمین‌ها.

## راه‌اندازی محلی

```bash
git clone https://github.com/shahramAnhari/running.git
cd running/server
npm install
node index.js
```

سرور Node روی پورت `3001` بالا می‌آید و هم API و هم فایل‌های استاتیک `/app` را سرو می‌کند. صفحات را از طریق مرورگر باز کنید:

- `http://localhost:3001/app/student.html`
- `http://localhost:3001/app/coach.html`
- `http://localhost:3001/app/admin.html`

> ⚠️ صفحات را مستقیماً با `file://` باز نکنید؛ در غیر این صورت call‌های `/api` شکست می‌خورند.

## نکات پایگاه داده

- فایل اصلی SQLite در `server/db.sqlite` نگهداری می‌شود. ستون‌های جدید `reset_token` و `reset_expires_at` برای بازیابی رمز اضافه شده‌اند.
- ثبت‌نام شاگرد از طریق `registerStudent` انجام می‌شود و وضعیت حساب ابتدا `pending` است. مربی در پنل خودش می‌تواند کاربر را به `approved` یا `rejected` تغییر دهد.
- مسیرهای API مربوط به فراموشی رمز:
  - `POST /api/auth/password/forgot` – تولید توکن و ارسال ایمیل (در محیط توسعه توکن در Response برگردانده می‌شود).
  - `POST /api/auth/password/reset` – ذخیره رمز جدید با توکن معتبر.

## تغییرات UI اخیر

- پنل شاگرد با تم شب، فونت‌آیکون (Font Awesome)، دکمه‌های نارنجی و مودال پیام‌ها بازطراحی شده است.
- فرم‌های ورود/ثبت‌نام/بازیابی رمز در یک کارت شیشه‌ای منظم قرار گرفته‌اند؛ چک‌باکس «مرا به خاطر بسپار» تراز مناسب دارد.
- در پنل مربی، شاگردان تأییدشده و در انتظار جدا شده‌اند، شمارنده‌ها در عنوان‌ها دیده می‌شوند و دکمه‌های تایید/رد برای هر شاگرد اضافه شده است.

## تست‌هایی که انجام شده

- `node --check server/index.js`
- `node --check server/db.js`
- `node --check app/js/student.js`
- `node --check app/js/coach.js`
- UI تست دستی روی `http://localhost:3001` برای سناریوهای ثبت‌نام، تأیید مربی و ورود شاگرد.

## ادامهٔ کار پیشنهادی

- افزودن سیستم ارسال ایمیل واقعی برای بازیابی رمز (فعلاً توکن در Response بازگردانده می‌شود).
- افزودن لاگین مربی و ادمین با OTP یا 2FA (در صورت نیاز).
- تکمیل مستندات برای استقرار روی سرور (نصب PM2، کانفیگ nginx) در یک فایل جداگانه.
- نوشتن تست‌های خودکار (integration یا unit) برای مسیرهای auth جدید.

در صورت نیاز به اطلاعات بیشتر یا سناریوهای تست، به بخش‌های بالاتر مراجعه کنید. موفق باشید! 🎯

## تغییرات انجام‌شده (۱۵ تا ۱۶ مهر ۱۴۰۴)

- **پنل مربی**
  - تب «انتساب برنامه» بازطراحی شد؛ فرم‌های «برنامه برای گروه‌ها» و «برنامه برای شاگردها» تب‌بندی شده و انتخاب چندگانه با چک‌باکس‌های واکنش‌گرا (مناسب موبایل) انجام می‌شود.
  - تب «گروه‌بندی سریع» کاملاً بازنویسی شد؛ جست‌وجوی زنده، افزودن/حذف شاگرد با یک کلیک، دیالوگ‌های گرافیکی و Toast برای نمایش نتیجه‌ی عملیات افزوده شده است.
  - حذف/ویرایش برنامه‌ها، گروه‌ها، شاگردها، پرداخت‌ها و انتساب‌ها با دیالوگ‌های مدرن و Toastهای یکپارچه انجام می‌شود.

- **پنل شاگرد**
  - کارت «برنامه‌ها» بازطراحی شد؛ برای هر روز برنامه می‌توان نظر ثبت کرد، نظرات نمایش داده می‌شوند و لینک «دفترچه تمرین» همان روز را باز می‌کند.
  - فرم ورود/ثبت‌نام تب‌بندی شد، لینک «فراموشی رمز؟» زیر فیلد رمز قرار گرفت و باکس اطلاع‌رسانی بالای فرم جایگزین مودال قدیمی شد.
  - گزینه‌ی «مرا به خاطر بسپار» اکنون ایمیل و رمز عبور (به صورت رمزگذاری‌شده) را ذخیره می‌کند تا پس از رفرش هم در دسترس باشد.

- **استایل‌ها و بک‌اند**
  - کلاس‌ها و استایل‌های جدید برای تب‌ها، چک‌باکس‌ها و کارت‌های برنامه به `app/styles.css` افزوده شد.
  - کوئری‌های حساس در `server/db.js` با کوتیشن صحیح بازنویسی شد تا عملیات حذف بدون خطا اجرا شود.

## راهنمای استقرار تغییرات روی سرور

1. **دریافت آخرین نسخه**
   ```bash
   cd /var/www/coach-app/coach-student-app
   git pull origin main
   ```
2. **نصب وابستگی‌های جدید (در سرور)**
   ```bash
   cd server
   npm install --production
   ```
3. **راه‌اندازی مجدد سرویس Node (PM2)**
   ```bash
   pm2 restart coach-api
   pm2 logs coach-api --lines 50   # در صورت نیاز برای بررسی
   ```
4. **تست سلامت API**
   ```bash
   curl http://127.0.0.1:3001/api/health
   curl https://shotarun.ir/api/health
   ```
5. **بازبینی رابط کاربری**
   - `https://shotarun.ir/app/coach.html` (Ctrl+F5) → تب «انتساب برنامه» و «گروه‌بندی سریع» را مرور کنید.
   - `https://shotarun.ir/app/student.html` → کارت‌های برنامه، ثبت نظر روزانه و گزینه‌ی «مرا به خاطر بسپار» را تست کنید.

6. **بازخوانی پیکربندی Nginx (در صورت نیاز)**
   ```bash
   sudo nginx -t
   sudo systemctl reload nginx
   ```

> پیش از جایگزینی دیتابیس (`server/db.sqlite*`) حتماً از نسخه‌ی فعلی بک‌آپ بگیرید تا داده‌های در حال استفاده از بین نرود.
